#! /usr/bin/env python3
import sys
import os
from argparse import ArgumentParser, RawTextHelpFormatter
from tempfile import mkstemp
from subprocess import run, PIPE


def __init__(parameters):
    parser = ArgumentParser(
        formatter_class = RawTextHelpFormatter,
        description = 'Simulte metagenomic paired-end reads using MetaSim.',
        epilog = 'Liucongcong congcong_liu@icloud.com.'
    )
    parser.add_argument(
        '-fasta', type = str, required = True, metavar = 'str',
        help = 'The fasta file to be simulated.'
    )
    parser.add_argument(
        '-coverage', type = int, required = True, metavar = 'int',
        help = 'Average coverage of simulated sequencing reads.'
    )
    parser.add_argument(
        '-output', type = str, required = True, metavar = 'str',
        help = 'The output file.'
    )
    parser.add_argument(
        '-metasim', default = 'MetaSim', type = str, required = False, metavar = 'str',
        help = 'The executable MetaSim file.\nDefault: MetaSim.'
    )
    parser.add_argument(
        '-threads', default = 10, type = int, required = False, metavar = 'int',
        help = 'The number of threads.\nDefault: 10'
    )
    parser.add_argument(
        '-mean', default = 2000, type = int, required = False, metavar = 'int',
        help = 'The mean of fragment length.\nDefault: 2000'
    )
    parser.add_argument(
        '-std', default = 200, type = int, required = False, metavar = 'int',
        help = 'The standard deviation of fragment length.\nDefault: 200'
    )
    return parser.parse_args(parameters)


def is_readable(file):
    if not os.access(file, os.R_OK):
        assert False, 'The file: {0} is not readable.'.format(os.path.abspath(file))
    return None


def is_writeable(file):
    try:
        open4w = open(file, 'wb')
        open4w.close()
        os.remove(file)
    except:
        assert False, 'The file: {0} is not writeable.'.format(os.path.abspath(file))
    return None


def read_fasta(file):
    genome_size = 0
    open4r = open(file, 'r')
    for line in open4r:
        if not line.startswith('>'):
            genome_size += len(line.rstrip('\n'))
    open4r.close()
    return genome_size


def generate_empirical_error_model():
    file_descriptor, file_name = mkstemp(suffix = '.mconf', dir = os.getcwd())
    os.write(file_descriptor, b'(A,C) 0.3177499213\n(A,T) 0.2331013755\n(A,G) 0.4491487033\n(C,A) 0.348955033\n(C,T) 0.4592411105\n(C,G) 0.1918038565\n(T,A) 0.2335116564\n(T,C) 0.4505485678\n(T,G) 0.3159397758\n(G,A) 0.4557969097\n(G,C) 0.1941909917\n(G,T) 0.3500120986\nA(A,C) 0.3467915188\nA(A,T) 0.222660182\nA(A,G) 0.4305482992\nC(A,C) 0.3341291871\nC(A,T) 0.2181408991\nC(A,G) 0.4477299138\nT(A,C) 0.2668071274\nT(A,T) 0.2830965567\nT(A,G) 0.4500963159\nG(A,C) 0.3063000023\nG(A,T) 0.2169547268\nG(A,G) 0.4767452709\nA(C,A) 0.3891652267\nA(C,T) 0.4284134676\nA(C,G) 0.1824213057\nC(C,A) 0.3728114304\nC(C,T) 0.4352754577\nC(C,G) 0.1919131119\nT(C,A) 0.3093465041\nT(C,T) 0.5038305847\nT(C,G) 0.1868229112\nG(C,A) 0.3273178457\nG(C,T) 0.459286923\nG(C,G) 0.2133952314\nA(T,A) 0.2954347062\nA(T,C) 0.4267966829\nA(T,G) 0.2777686109\nC(T,A) 0.2148171883\nC(T,C) 0.4915133608\nC(T,G) 0.2936694509\nT(T,A) 0.2264459069\nT(T,C) 0.452268915\nT(T,G) 0.321285178\nG(T,A) 0.2021642762\nG(T,C) 0.4392480777\nG(T,G) 0.3585876461\nA(G,A) 0.4920421191\nA(G,C) 0.1968949896\nA(G,T) 0.3110628913\nC(G,A) 0.5169158143\nC(G,C) 0.2279563793\nC(G,T) 0.2551278063\nT(G,A) 0.3814479001\nT(G,C) 0.1705232006\nT(G,T) 0.4480288993\nG(G,A) 0.4569728189\nG(G,C) 0.1926033358\nG(G,T) 0.3504238454\nSUBSTITUTION_ERROR\n0.008789032316\n0.007422160749\n0.00679695842\n0.006656465945\n0.006525677769\n0.006499030249\n0.00644482254\n0.006361008543\n0.006391366739\n0.006458465211\n0.006387100236\n0.006343671901\n0.006371282739\n0.006299157336\n0.00642508232\n0.006354354386\n0.006382183878\n0.006376828773\n0.006408814543\n0.006489086637\n0.006989498721\n0.01023023646\n0.007147621025\n0.006454312443\n0.006482541983\n0.006532153728\n0.006573776463\n0.006650062776\n0.00665673508\n0.00670376547\n0.006744919897\n0.006673507056\n0.006692785958\n0.006782317187\n0.006836615184\n0.00689679129\n0.006940277109\n0.007050578432\n0.00715867155\n0.007228921894\n0.008050657472\n0.007956833905\n0.008275809926\n0.008142145755\n0.008289538419\n0.008268844271\n0.00842939318\n0.008629267714\n0.008651526403\n0.009008996804\n0.009184206844\n0.01507237308\n0.009920528602\n0.008364801018\n0.008432865581\n0.008793160336\n0.01907411738\n0.009006749887\n0.009023681217\n0.0091999651\n0.009663165334\n0.009923358499\n0.01003389297\n0.0102562446\n0.01059275215\n0.0110156145\n0.01149947568\n0.01161083425\n0.01210869349\n0.01237057255\n0.0128284016\n0.01337169051\n0.01394714396\n0.01450165868\n0.01568401639\n0.01621183664\n0.01686702883\n0.01759580779\n0.01815845659\n0.0226369259\nSUBSTITUTION_ERROR (A)\n0.007411579315\n0.007312976235\n0.006567944867\n0.006608330921\n0.006416955499\n0.006493010368\n0.006453431216\n0.006297493352\n0.006478317682\n0.006456586317\n0.006475695353\n0.006400389501\n0.006421529499\n0.006309971565\n0.006422282458\n0.006431398208\n0.006432438949\n0.006456633404\n0.006452650318\n0.006479879347\n0.007121622822\n0.01022607226\n0.007306212515\n0.006466119813\n0.006415776946\n0.006353514896\n0.006497744197\n0.006552715919\n0.00649983148\n0.00659311762\n0.006733059897\n0.006685079735\n0.006624542666\n0.006803962921\n0.006910536836\n0.006932568569\n0.006889571063\n0.006894405216\n0.007018596634\n0.007046115098\n0.008510377583\n0.008359807036\n0.008775709924\n0.008571986093\n0.008648768899\n0.008569617338\n0.00865036131\n0.00887141362\n0.009071244595\n0.009682662493\n0.009888652878\n0.01536634998\n0.01078356941\n0.008690296458\n0.008629903139\n0.008980717132\n0.01931118226\n0.009304548867\n0.00937128001\n0.009447400957\n0.01016365636\n0.01030270769\n0.01044633059\n0.01064766881\n0.01110829505\n0.01144794199\n0.01196777393\n0.012594799\n0.01278615465\n0.0128507923\n0.01303167946\n0.01423638038\n0.0140963071\n0.01489061979\n0.01554401529\n0.01614374208\n0.01679150163\n0.01740745205\n0.01810882026\n0.0155150068\nSUBSTITUTION_ERROR (C)\n0.009074017351\n0.00766131908\n0.007138137325\n0.006777072928\n0.006735777411\n0.006497285235\n0.006534411233\n0.006363945658\n0.006392047585\n0.006458787058\n0.006284458519\n0.00635702293\n0.006411743741\n0.006267903925\n0.006354961024\n0.006315724142\n0.006331370704\n0.006199754127\n0.006397884541\n0.006567103959\n0.006809333333\n0.01016221114\n0.006883030127\n0.006395587596\n0.006607007454\n0.006708644666\n0.006660765223\n0.006662369513\n0.006879148251\n0.006741179543\n0.006805982848\n0.006697437068\n0.006637719182\n0.006674850711\n0.006860513023\n0.00686841267\n0.006958043415\n0.007266773829\n0.007296539823\n0.007412368407\n0.007390207603\n0.007426380556\n0.007670600262\n0.007562503426\n0.007770779845\n0.007978521933\n0.008089099402\n0.008174670846\n0.008137484523\n0.008014930684\n0.008083006812\n0.01442937852\n0.008716413634\n0.007948421932\n0.008108059744\n0.008561920821\n0.01877569212\n0.008693547243\n0.008516383126\n0.008810375831\n0.009018303781\n0.009368533701\n0.009397295378\n0.009808723618\n0.00999169746\n0.01049207867\n0.01071781072\n0.01019248015\n0.01117097562\n0.01164071639\n0.01238813406\n0.01213730008\n0.01356330808\n0.0138295035\n0.01600614314\n0.01630977935\n0.01691368882\n0.01769153621\n0.0180504335\n0.01843893605\nSUBSTITUTION_ERROR (T)\n0.009586473201\n0.007289641766\n0.006538210711\n0.006587791288\n0.006434809895\n0.006504306757\n0.006318905013\n0.006348705348\n0.006350534314\n0.006466260138\n0.006382127841\n0.006345100323\n0.006327484896\n0.006375681804\n0.006506660716\n0.006372039669\n0.006381453034\n0.006488178351\n0.006417154322\n0.006466548058\n0.007050240264\n0.01022542\n0.007385160771\n0.006511070638\n0.006447095114\n0.006526826219\n0.006527906939\n0.006544786492\n0.006517470277\n0.006655498136\n0.006570997043\n0.006652223554\n0.006790814248\n0.006834142989\n0.006770453904\n0.006937949191\n0.006917482158\n0.006910936914\n0.006988371095\n0.007096754947\n0.008561466758\n0.008393704974\n0.00865608929\n0.008439242161\n0.008650174883\n0.00848641506\n0.008717314265\n0.00898943404\n0.009021745571\n0.009615295728\n0.01001561443\n0.01562508536\n0.01080159922\n0.008579475662\n0.008708297856\n0.008926263875\n0.01924845723\n0.009189941867\n0.009353941187\n0.009568928828\n0.01005934416\n0.01033918158\n0.01050587572\n0.01059190818\n0.0109836788\n0.01127220139\n0.01214001523\n0.01262115331\n0.01279053167\n0.01291774844\n0.01308783487\n0.01409249258\n0.01415238517\n0.0149034984\n0.01555507952\n0.01616471827\n0.01689901976\n0.01757066624\n0.01823943225\n0.02927612114\nSUBSTITUTION_ERROR (G)\n0.009345794393\n0.007556700453\n0.007213929562\n0.006704082649\n0.006605427585\n0.006501818682\n0.006524925044\n0.006467298515\n0.006324923251\n0.006449770701\n0.006371607436\n0.006248524538\n0.006321670711\n0.006206825298\n0.006384122282\n0.006259081656\n0.006363019474\n0.006285224297\n0.006346274313\n0.006455583848\n0.006899512888\n0.01031089282\n0.006854329467\n0.006416847512\n0.006501891141\n0.006614754108\n0.006657704486\n0.006923074182\n0.006851774369\n0.006889592416\n0.006945549552\n0.006663272177\n0.006706025931\n0.006786068694\n0.00680152807\n0.006816632584\n0.007026595966\n0.007253393259\n0.007459383083\n0.007491458074\n0.00733521972\n0.007299638582\n0.007634182349\n0.007690043812\n0.007788415216\n0.007823041514\n0.008047090514\n0.008230729365\n0.00804399192\n0.008184277478\n0.008111888777\n0.01451291654\n0.008646450295\n0.00801586036\n0.008087147714\n0.008568792334\n0.0187893778\n0.008637197179\n0.008567396294\n0.008716625713\n0.009034211562\n0.009348012504\n0.00941954693\n0.009671775767\n0.009907156202\n0.01056341177\n0.0107064746\n0.01019532479\n0.01111949232\n0.01164009027\n0.01261145728\n0.01236230329\n0.01382779516\n0.01405011537\n0.01574361976\n0.01627745902\n0.01688238268\n0.01780238287\n0.01822220761\n0.02784111761\nSUBSTITUTION_ERROR A(A)\n0.007433497892\n0.006940559753\n0.006230092536\n0.006275782714\n0.006208962434\n0.006220568496\n0.0061962524\n0.005882435489\n0.006183815851\n0.006121330602\n0.006349525137\n0.006042910587\n0.006032407039\n0.005894587302\n0.006134051083\n0.006013393292\n0.006098404501\n0.00605157543\n0.006040712678\n0.006166848145\n0.006782623491\n0.01229892273\n0.006976148059\n0.006171824625\n0.00609538898\n0.005920346527\n0.00607564948\n0.006155279871\n0.006128396825\n0.006304879657\n0.006356909919\n0.006440276548\n0.00640646333\n0.006498656774\n0.006592874702\n0.006586820236\n0.006614131782\n0.006368438193\n0.006585809334\n0.006737647434\n0.008490963017\n0.008329725738\n0.008528762922\n0.008450010348\n0.008419611817\n0.008192560153\n0.00853214796\n0.008690726243\n0.008837393987\n0.009683739794\n0.009601432457\n0.01506047849\n0.01054313464\n0.008448846227\n0.008312835727\n0.008828002214\n0.01877634046\n0.009131305426\n0.009052704973\n0.009098160141\n0.01003618123\n0.01009403147\n0.01027509801\n0.01018219632\n0.01083578125\n0.0111225441\n0.01181514157\n0.01249190222\n0.01233579879\n0.01225244162\n0.01247853841\n0.01368140365\n0.01329890202\n0.01430164156\n0.01483233347\n0.01526515824\n0.01613225446\n0.01656712608\n0.01779705338\n0.01245915649\nSUBSTITUTION_ERROR C(A)\n0.007374659619\n0.007607444885\n0.006727631708\n0.006773953058\n0.006650545236\n0.006504812421\n0.006631483801\n0.006619619252\n0.006720546327\n0.006553039847\n0.006717084025\n0.006613174724\n0.006704994636\n0.006586003425\n0.006681878926\n0.006823020811\n0.006671510308\n0.006830833953\n0.006943642661\n0.0068895636\n0.007383321695\n0.009761764525\n0.007617664412\n0.006907430258\n0.006938029549\n0.006770895884\n0.006833650818\n0.006970156256\n0.007120782923\n0.007168159731\n0.007241864184\n0.006971822294\n0.007116041607\n0.007152311184\n0.007589616272\n0.007395417379\n0.007472677571\n0.007582793951\n0.007781414161\n0.007694699769\n0.00897525936\n0.008943462724\n0.009331276614\n0.00909973528\n0.009290861862\n0.009224754993\n0.009319905671\n0.00954500854\n0.009669000418\n0.01024097154\n0.01068795755\n0.01610910851\n0.01179477278\n0.009525422988\n0.009663795539\n0.009770618679\n0.02037975652\n0.01028815531\n0.0105518388\n0.01051820466\n0.01139878348\n0.01137274622\n0.01149048953\n0.01195524391\n0.01240627875\n0.0128671742\n0.01314622615\n0.01399311075\n0.01430082042\n0.014718828\n0.01463236636\n0.01614004843\n0.01587292952\n0.01663351653\n0.01762804997\n0.01820814209\n0.01875340597\n0.01917817735\n0.01961910613\n0.01518505228\nSUBSTITUTION_ERROR T(A)\n0.008968810292\n0.008919476838\n0.007841204048\n0.007665155791\n0.007356985026\n0.007573488338\n0.007564433201\n0.007459645049\n0.007654058077\n0.007626674791\n0.007545709998\n0.007573822417\n0.007548541522\n0.007480999284\n0.007319710539\n0.007535335916\n0.007791086006\n0.007648835832\n0.007684873058\n0.007536839477\n0.008146512523\n0.009722839018\n0.008232226411\n0.007527281559\n0.007323952107\n0.007468176841\n0.007710823712\n0.007584488897\n0.007522498699\n0.007487222822\n0.007720401572\n0.00765224762\n0.007597758683\n0.007863386175\n0.007810233304\n0.007947869136\n0.007992349059\n0.007839420722\n0.007853347593\n0.007780806355\n0.009298797976\n0.008897932108\n0.009514854651\n0.009314426733\n0.009259102096\n0.009340948866\n0.009151090756\n0.009523748772\n0.009856560714\n0.0100382733\n0.01050489204\n0.01597646153\n0.01130069019\n0.009106801212\n0.008936626191\n0.009390287252\n0.01990268949\n0.00947009777\n0.009476618674\n0.009745287836\n0.01010079625\n0.01058095301\n0.01052410466\n0.01068462468\n0.01089074032\n0.01127907273\n0.01159815361\n0.01185621795\n0.01248430463\n0.01251785318\n0.01257169513\n0.01354659945\n0.01365133495\n0.01415181541\n0.01476735174\n0.01574481678\n0.01634681004\n0.01709310877\n0.01771486299\n0.01528260796\nSUBSTITUTION_ERROR G(A)\n0.005710116293\n0.00608422303\n0.005833999431\n0.005933542833\n0.005629571075\n0.005890976021\n0.00567267966\n0.005581039358\n0.005652867638\n0.005828234953\n0.005529683637\n0.005714406134\n0.005745335875\n0.005653324402\n0.005830898693\n0.005713783094\n0.00554968564\n0.005673490615\n0.005530696854\n0.005656275943\n0.00649860881\n0.008271234872\n0.006704248983\n0.00558160615\n0.005605095096\n0.005636347841\n0.005761941129\n0.005846730275\n0.005583925515\n0.005707070707\n0.005944937721\n0.005958362746\n0.005654615\n0.00601447528\n0.005961733104\n0.006129238577\n0.005793459246\n0.006180422332\n0.006195564804\n0.006234088444\n0.007449083751\n0.007398047781\n0.00796692091\n0.007626710357\n0.007847754264\n0.007818313298\n0.007761558238\n0.007941373113\n0.008167777733\n0.008857955245\n0.009010595777\n0.01456437839\n0.009722596517\n0.007879095377\n0.007813565665\n0.008098024325\n0.01853372229\n0.008456434061\n0.008592035121\n0.008656802209\n0.009200253439\n0.009337191869\n0.009621453854\n0.009994429106\n0.01041842762\n0.01067539913\n0.01134593915\n0.01200367413\n0.01220134134\n0.01214158585\n0.01263911483\n0.01374459291\n0.01384159338\n0.01463959639\n0.01516739874\n0.01569918073\n0.01618908827\n0.01712355131\n0.01740843196\n0.02041814227\nSUBSTITUTION_ERROR A(C)\n0.008836889805\n0.007819409695\n0.007656716656\n0.007120125865\n0.007180093364\n0.00675944334\n0.006978543312\n0.006756219154\n0.006795575569\n0.006738017555\n0.006724355265\n0.0067462621\n0.006614178934\n0.006699405298\n0.006693295665\n0.006653951727\n0.006576738758\n0.006626348096\n0.006806836747\n0.006955835962\n0.006925640492\n0.009861118631\n0.007409371756\n0.00686135449\n0.007251453002\n0.007009382799\n0.007027138279\n0.007000106509\n0.007050392973\n0.006921410835\n0.007192564887\n0.007138683134\n0.006944899874\n0.006920156061\n0.007218312649\n0.007251278872\n0.007223507006\n0.007643389996\n0.007519714395\n0.007660896985\n0.007746764074\n0.00799910843\n0.007972711675\n0.007887275422\n0.008137036222\n0.00811375139\n0.008556273167\n0.00854501635\n0.008583155416\n0.008377646915\n0.008561183427\n0.01497163484\n0.008822955565\n0.008744373275\n0.008629666179\n0.009230497346\n0.01953849472\n0.0093992292\n0.008922258281\n0.009435805622\n0.009580314707\n0.01019195685\n0.009945889303\n0.01050573205\n0.01080671089\n0.01099807783\n0.01126343377\n0.01091272773\n0.01204367442\n0.01247805439\n0.01318982609\n0.01307842061\n0.01463335887\n0.01472060817\n0.01703897712\n0.01743765935\n0.01782250794\n0.01887880425\n0.01907361297\n0.02377413243\nSUBSTITUTION_ERROR C(C)\n0.01077142186\n0.008511054234\n0.007428529551\n0.007047233029\n0.006731989493\n0.006620888288\n0.006694553269\n0.006506899321\n0.006682282439\n0.007006676951\n0.006616880555\n0.006475164818\n0.006754531447\n0.006666215385\n0.006705292433\n0.006613551187\n0.006691521728\n0.00663854022\n0.006658923508\n0.00686785205\n0.006991755387\n0.013246929\n0.007377948197\n0.006611479061\n0.006613389731\n0.006952031274\n0.007041479029\n0.007052255536\n0.00722650804\n0.00731835269\n0.007174864512\n0.007027505003\n0.007317257233\n0.007029917685\n0.007047039573\n0.007096396115\n0.007497627058\n0.007781431352\n0.007786241295\n0.007891165971\n0.008042903269\n0.007766311002\n0.008392479361\n0.008045846142\n0.008206450258\n0.008552397298\n0.008646208857\n0.008814006651\n0.008906686011\n0.008511944794\n0.008320487668\n0.01482726369\n0.009279213858\n0.008613753332\n0.008605299698\n0.009059491049\n0.01910263794\n0.009256145174\n0.009285511143\n0.009454713062\n0.009642646277\n0.009876680499\n0.009989176447\n0.01044560733\n0.01059430692\n0.01135949158\n0.01152659602\n0.0108156946\n0.01165433574\n0.01225348409\n0.01320375021\n0.01256908332\n0.01426029116\n0.01432343622\n0.01663417119\n0.01718805827\n0.01737185549\n0.01825231311\n0.01869516903\n0.01586770675\nSUBSTITUTION_ERROR T(C)\n0.009020193808\n0.007524634439\n0.006585002004\n0.006419912299\n0.006556909829\n0.006399148887\n0.006249739443\n0.006011902424\n0.005991118799\n0.006040063472\n0.005949903197\n0.006000591608\n0.006061652038\n0.00570585792\n0.005810592603\n0.005851909779\n0.006051625574\n0.005707884069\n0.006060934412\n0.006023674809\n0.006595227092\n0.009027590115\n0.006238339246\n0.005938951964\n0.006235809816\n0.006360247492\n0.006269095295\n0.006209923671\n0.006431138185\n0.006266672017\n0.00636683589\n0.006276776976\n0.006134798443\n0.006253537266\n0.006545796951\n0.006455859995\n0.006510714641\n0.00673383564\n0.006786875678\n0.006878513947\n0.006757879383\n0.006898030479\n0.007184926318\n0.007018028863\n0.007143479094\n0.007458802819\n0.007470034022\n0.007447233498\n0.007392710427\n0.007408275577\n0.00756696881\n0.01392648283\n0.008220685016\n0.006971916972\n0.007533871833\n0.0078029129\n0.01805990415\n0.007894250195\n0.007710550255\n0.007914642525\n0.008158937714\n0.008480507112\n0.00858397588\n0.008997193295\n0.008980776511\n0.009299711479\n0.009636384972\n0.009019211112\n0.01012675933\n0.01042617814\n0.01095939413\n0.01088008287\n0.01214663422\n0.01245467997\n0.01445013729\n0.01449876668\n0.0152782197\n0.0159074894\n0.0161805777\n0.01567292599\nSUBSTITUTION_ERROR G(C)\n0.007865482528\n0.006888633754\n0.007082823986\n0.006637315058\n0.006448592297\n0.006175561057\n0.006245528308\n0.006295444087\n0.006249053993\n0.006243193743\n0.005916906321\n0.006321946669\n0.006389499159\n0.006244537966\n0.006478967324\n0.006353346947\n0.006108793829\n0.006021125122\n0.006156688656\n0.006673571065\n0.006834552254\n0.00928977106\n0.006777504219\n0.006339739818\n0.006374797313\n0.00665493954\n0.006449152568\n0.00658724165\n0.007066583398\n0.00672055413\n0.006662899874\n0.006485128344\n0.006388390784\n0.006707220998\n0.006730094771\n0.006835874123\n0.006812395206\n0.007148070698\n0.007373496804\n0.007510522814\n0.00732969111\n0.007224500264\n0.007350333767\n0.00756970384\n0.007923846814\n0.008107644573\n0.007955264431\n0.008281412657\n0.008033629145\n0.00806698947\n0.008090403899\n0.01415775247\n0.008852469193\n0.007890304912\n0.007883907974\n0.00846359816\n0.01865880902\n0.008551828129\n0.008573292331\n0.008864895758\n0.009112760671\n0.009275930158\n0.009458576942\n0.009619411335\n0.0100264639\n0.01099730659\n0.01103080069\n0.01063029838\n0.01131406421\n0.01199896205\n0.01295700897\n0.01262074687\n0.01387753824\n0.01452629675\n0.01668885404\n0.01705602646\n0.0180819645\n0.01863915751\n0.01929467521\n0.01879242542\nSUBSTITUTION_ERROR A(T)\n0.01000401896\n0.007285332777\n0.006418458744\n0.006373076419\n0.006242154263\n0.006514139459\n0.006336864823\n0.006127481701\n0.006291635233\n0.006292654378\n0.006368986587\n0.006216056319\n0.006174745292\n0.006204982393\n0.006308944246\n0.006371239053\n0.006243801098\n0.006365060872\n0.006280414932\n0.006251992175\n0.00687695368\n0.008628386824\n0.007032205132\n0.006296076274\n0.005987101961\n0.006245152599\n0.006255360753\n0.00642754179\n0.006192025329\n0.006332117113\n0.006264217594\n0.00630954492\n0.006372798205\n0.006633066011\n0.006374144785\n0.006528681406\n0.006498501708\n0.006460296529\n0.00663132527\n0.006698803831\n0.008071916064\n0.007877515782\n0.008137017496\n0.007877383882\n0.008132104553\n0.007845327632\n0.008057816913\n0.008266214157\n0.00838636349\n0.008692906723\n0.00914951633\n0.01491029772\n0.01007284425\n0.007672744999\n0.007811423867\n0.007875037237\n0.01821530905\n0.008161588541\n0.00818205596\n0.008399225328\n0.008835859814\n0.009059438757\n0.009157503276\n0.009262118434\n0.009736823538\n0.009953666181\n0.01054628371\n0.01094671382\n0.01110868602\n0.0111371479\n0.01130798711\n0.01182075628\n0.01207560997\n0.0126472954\n0.0133765753\n0.01381849533\n0.01449450145\n0.01494275461\n0.01545121814\n0.02250009611\nSUBSTITUTION_ERROR C(T)\n0.009256103663\n0.007021231165\n0.006053159103\n0.006304056758\n0.00599925225\n0.00599932605\n0.005772838249\n0.00595258742\n0.00591314259\n0.006017985958\n0.005927452393\n0.006081615277\n0.006033100064\n0.006040766163\n0.006176586639\n0.005884460198\n0.005943843281\n0.005875151609\n0.006069388638\n0.005991500693\n0.006521041403\n0.008513060813\n0.006901350289\n0.006072633234\n0.005988383888\n0.005965407429\n0.006098652343\n0.006090700064\n0.006157084047\n0.00623435972\n0.00586265444\n0.00622687993\n0.006521558371\n0.00611943846\n0.006407766258\n0.006472987905\n0.006358442379\n0.006304402877\n0.006280912982\n0.006364218697\n0.007880464525\n0.007703735585\n0.008240599125\n0.007794313269\n0.007914248109\n0.007947199035\n0.008003186926\n0.008380842487\n0.008365209309\n0.009340971937\n0.009401977534\n0.01513503323\n0.01023448927\n0.007846415748\n0.008141217433\n0.008297185991\n0.01871748334\n0.008472034929\n0.008797504254\n0.009000475504\n0.009539831244\n0.009464324163\n0.009666308795\n0.009782410119\n0.01020587585\n0.01040880634\n0.01158906692\n0.01200041008\n0.01196918958\n0.01220989014\n0.01202071635\n0.01330117318\n0.01330821424\n0.01375233672\n0.01439001968\n0.01522349037\n0.01567461107\n0.0166186013\n0.01687716574\n0.02332438679\nSUBSTITUTION_ERROR T(T)\n0.009991415921\n0.007119016538\n0.005980488267\n0.006136203345\n0.005987939168\n0.005917957552\n0.005887771911\n0.005826520546\n0.005743993694\n0.005900340957\n0.005811375934\n0.005781940464\n0.00578265794\n0.005753082927\n0.005956566169\n0.005858785028\n0.00586296194\n0.005847171124\n0.005812202149\n0.005879976718\n0.006432789288\n0.01199301438\n0.006801296537\n0.005957052197\n0.005865770482\n0.005954134637\n0.005827447509\n0.005828376033\n0.005765571084\n0.005938217919\n0.005963198764\n0.005987395361\n0.005888061536\n0.006222956192\n0.005958041241\n0.006276832052\n0.0062088357\n0.006050811498\n0.006018935259\n0.006191922836\n0.007552587229\n0.007461010287\n0.007429295492\n0.007322910832\n0.007521446234\n0.007198939559\n0.007482022803\n0.007662284645\n0.007759090238\n0.0084220688\n0.008700468074\n0.01421337257\n0.009213499192\n0.007209614862\n0.007115986502\n0.007279307804\n0.01725773748\n0.007453253272\n0.007467846068\n0.007655598802\n0.008029267647\n0.008328121902\n0.008353082078\n0.008364519646\n0.00844476709\n0.008630653939\n0.009138702475\n0.01019683448\n0.01000188475\n0.009741273708\n0.00985107063\n0.01078088876\n0.01045615603\n0.01105645775\n0.01134247589\n0.01167890663\n0.01246695095\n0.01262193826\n0.01341037774\n0.01568432918\nSUBSTITUTION_ERROR G(T)\n0.008520082725\n0.007881915214\n0.008197195223\n0.008122881558\n0.007975122741\n0.008110591897\n0.007691874416\n0.008039695999\n0.008020907214\n0.008247735782\n0.007933213933\n0.00781861005\n0.007850300172\n0.008100947849\n0.008143605925\n0.007859958056\n0.0080018017\n0.008519566967\n0.008088868983\n0.008358803267\n0.009009457667\n0.01141068958\n0.009481840019\n0.008310637797\n0.008661148659\n0.008598287122\n0.008664194423\n0.008524660057\n0.008725534882\n0.008881051038\n0.008939681038\n0.00881461094\n0.009296302082\n0.009054874805\n0.009198982317\n0.009247780578\n0.009441984177\n0.009793509258\n0.0100669541\n0.01015245701\n0.0118622189\n0.01160874011\n0.01207606102\n0.01199067367\n0.01227645153\n0.01234511807\n0.01270299237\n0.01309625647\n0.01297571947\n0.01336862675\n0.01432133757\n0.01974399789\n0.01534021217\n0.01316522298\n0.01349613084\n0.01410848279\n0.0248911833\n0.01462599914\n0.01503667426\n0.01532199381\n0.01604595339\n0.01678702734\n0.0172641132\n0.01742237141\n0.01817692235\n0.0188774409\n0.02043056796\n0.02004936905\n0.02115543686\n0.02194820088\n0.02260048051\n0.02416420818\n0.02469722859\n0.02631232762\n0.02752287325\n0.02860481878\n0.02962779753\n0.03122986666\n0.03240960868\n0.07104830575\nSUBSTITUTION_ERROR A(G)\n0.009299222569\n0.007368138168\n0.006964351799\n0.006370362834\n0.006321114985\n0.006254855891\n0.006128024535\n0.006053828658\n0.006004538115\n0.006114544016\n0.005949449344\n0.005988316122\n0.005947118255\n0.005805214131\n0.006070798329\n0.005883262204\n0.005977345031\n0.00586093948\n0.005746236819\n0.006090613412\n0.006383694425\n0.00921450578\n0.006428896555\n0.005958424524\n0.006123060513\n0.00626236488\n0.00632512847\n0.006499225789\n0.006428873537\n0.006295147897\n0.006555883161\n0.006328410818\n0.006168140896\n0.006505632191\n0.006303247036\n0.006245670551\n0.006565418498\n0.006816192026\n0.006867056201\n0.007095117807\n0.006727335734\n0.006743629347\n0.007095193214\n0.007055416612\n0.007112081519\n0.007206680742\n0.00735730435\n0.00769946521\n0.00736398932\n0.007651535386\n0.007698709946\n0.01397111192\n0.008195752615\n0.007310901446\n0.007349644105\n0.008009386029\n0.01831968787\n0.007730347941\n0.007716380645\n0.007979393935\n0.008128066235\n0.008402237079\n0.00848572581\n0.008703686245\n0.008972510157\n0.009617882108\n0.009873270717\n0.009237609648\n0.0101691975\n0.0106992235\n0.01162808229\n0.01128028503\n0.01258186539\n0.01304058625\n0.01433387317\n0.01504668097\n0.0156592487\n0.01654991309\n0.01684541609\n0.02654605061\nSUBSTITUTION_ERROR C(G)\n0.01124789055\n0.009803447685\n0.009951616963\n0.00894570782\n0.009173286991\n0.009147421258\n0.009151437881\n0.00925809507\n0.008591871919\n0.009204097715\n0.008752424098\n0.008799700369\n0.008696843382\n0.008856027315\n0.008797527097\n0.008900625978\n0.008836901451\n0.008835661386\n0.008993592598\n0.00904656493\n0.009459370435\n0.0122982618\n0.00975837516\n0.009091121459\n0.008903804\n0.009065815006\n0.008912413162\n0.009237552049\n0.009252699683\n0.009511674304\n0.009560836583\n0.009378484653\n0.009348428618\n0.009298416935\n0.009207900567\n0.00956132904\n0.009918821149\n0.009794303922\n0.01027285936\n0.01026521061\n0.01003653582\n0.01008155468\n0.01050594739\n0.01034817121\n0.01074588631\n0.01041841707\n0.01081013086\n0.01087528366\n0.0109099124\n0.01061927339\n0.01085679944\n0.01709411742\n0.01119816865\n0.01087662719\n0.01089841676\n0.01119537739\n0.0210436324\n0.01140663623\n0.01160274468\n0.01128933388\n0.01207652903\n0.01233358669\n0.01230210551\n0.01244089892\n0.01317907998\n0.01345229763\n0.01377033276\n0.01338060834\n0.0143481316\n0.01515632657\n0.01561668984\n0.01596980256\n0.01787335274\n0.01805122167\n0.01994740959\n0.0208341463\n0.02116801819\n0.02182727979\n0.02285278175\n0.03369059877\nSUBSTITUTION_ERROR T(G)\n0.008420569613\n0.006820268203\n0.006879374659\n0.006353342774\n0.006111875146\n0.006017646317\n0.005969425521\n0.005942784775\n0.005923070026\n0.0057807204\n0.005945750478\n0.005675450833\n0.005779781806\n0.005687136473\n0.005939138798\n0.005748385473\n0.005864500791\n0.005850905045\n0.005796865238\n0.005874757791\n0.006467445441\n0.00898399393\n0.006316313118\n0.00592140581\n0.005984989567\n0.006173433711\n0.006231053314\n0.006464066808\n0.006391272157\n0.006481180171\n0.006348234629\n0.006151088032\n0.006301100109\n0.006362265979\n0.006590815368\n0.006357920675\n0.006479560197\n0.006779648674\n0.00693739149\n0.006971936506\n0.00691594204\n0.006780791866\n0.007129337768\n0.007266136598\n0.007450803611\n0.007571582909\n0.007700998237\n0.007905252952\n0.007695516541\n0.007971349774\n0.007533837886\n0.01430321359\n0.008337708169\n0.00786979788\n0.007934130378\n0.008203376747\n0.018716597\n0.008729614264\n0.008431902824\n0.008594212854\n0.009120689248\n0.009185491186\n0.009383224625\n0.009703549121\n0.009989346643\n0.01062513645\n0.01056828676\n0.01031428358\n0.01110163344\n0.01151761394\n0.0126822341\n0.01247287318\n0.01358741675\n0.01390481966\n0.01554732599\n0.01614514559\n0.01698135266\n0.0179030466\n0.01794590289\n0.02779233016\nSUBSTITUTION_ERROR G(G)\n0.009591252918\n0.007540516337\n0.00634938968\n0.00616304274\n0.00601491887\n0.005786432798\n0.006113203265\n0.006000690474\n0.005831761622\n0.006004911763\n0.005953442675\n0.005688815905\n0.00599921467\n0.005703811116\n0.005793512667\n0.005689436172\n0.005928122606\n0.005743752296\n0.006163571249\n0.006029158257\n0.006473379994\n0.01265094714\n0.006204981971\n0.00592913329\n0.006116234658\n0.00604361587\n0.006177787166\n0.00658311952\n0.006463010164\n0.006513320203\n0.006540945854\n0.005982757119\n0.006228670425\n0.006019908635\n0.006130483853\n0.006397134084\n0.006459404296\n0.006803868319\n0.007124026659\n0.006867329047\n0.006945995897\n0.006931238404\n0.007134263153\n0.007378406427\n0.007183782174\n0.007240376993\n0.00762328046\n0.007613018993\n0.007508089475\n0.00755151147\n0.007645906959\n0.01375851644\n0.007947298708\n0.007211636601\n0.007370149867\n0.008068752189\n0.01795810649\n0.00781584771\n0.007850931677\n0.008147084439\n0.008018109006\n0.008848315428\n0.008778408676\n0.009038911339\n0.008792017666\n0.009785090527\n0.009928562425\n0.009120105767\n0.01021685225\n0.0106649697\n0.01179115985\n0.01117812344\n0.0131126069\n0.01286230133\n0.0151166353\n0.01497308903\n0.01542686161\n0.01658710275\n0.01733057956\n0.02540063761\n')
    os.close(file_descriptor)
    return file_name


def run_metasim(metasim, mean, std, empirical_error_model, reads, threads, fasta):
    run(
        [
            metasim, 'cmd', '--reads', str(reads), '--clones-mean', str(mean), '--clones-param2', str(std), '--empirical', '--empirical-cfg',
            empirical_error_model, '--empirical-read2-cfg', empirical_error_model, '--empirical-pe-probability', '1', '--threads', str(threads),
            '--no-progress', '--combine', fasta
        ],
        stdout = PIPE,
        check = True
    )
    return None


def parse_output_file(input_file, output_file, sequence_id_prefix):
    open4r = open(input_file, 'r')
    open4w = open(output_file, 'w')
    for line in open4r:
        if line.startswith('>'):
            read_id, mate_id = line.split(' ', maxsplit = 1)[0][2 : ].split('.', maxsplit = 1)
            open4w.write('>' + sequence_id_prefix + '.' + read_id + ' ' + mate_id + '\n')
        else:
            open4w.write(line)
    open4r.close()
    open4w.close()
    return None


if __name__ == '__main__':
    parameters = __init__(sys.argv[1:])
    is_readable(parameters.fasta)
    genome_size = read_fasta(parameters.fasta)
    is_writeable(parameters.output)
    empirical_error_model = generate_empirical_error_model()
    run_metasim(
        parameters.metasim,
        parameters.mean,
        parameters.std,
        empirical_error_model,
        int(parameters.coverage * genome_size / 160),
        parameters.threads,
        os.path.abspath(parameters.fasta)
    )
    os.remove(empirical_error_model)
    file_prefix = os.path.splitext(os.path.basename(parameters.fasta))[0]
    parse_output_file(file_prefix + '-Empirical.fna', parameters.output, file_prefix.replace(' ', '_'))
    os.remove(file_prefix + '-Empirical.fna')